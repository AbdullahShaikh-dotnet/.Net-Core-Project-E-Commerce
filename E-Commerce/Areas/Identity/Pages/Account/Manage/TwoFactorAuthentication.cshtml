@page
@using Microsoft.AspNetCore.Http.Features
@model TwoFactorAuthenticationModel
@{
    ViewData["Title"] = "Two-Factor Authentication (2FA)";
    ViewData["ActivePage"] = ManageNavPages.TwoFactorAuthentication;
}

<partial name="_StatusMessage" for="StatusMessage" />

<h3 class="text-3xl font-bold text-gray-900 mb-6 flex items-center">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-7 mr-3">
        <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 1 0-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 0 0 2.25-2.25v-6.75a2.25 2.25 0 0 0-2.25-2.25H6.75a2.25 2.25 0 0 0-2.25 2.25v6.75a2.25 2.25 0 0 0 2.25 2.25Z" />
    </svg>
    @ViewData["Title"]
</h3>

@{
    var consentFeature = HttpContext.Features.Get<ITrackingConsentFeature>();
    @if (consentFeature?.CanTrack ?? true)
    {
        @if (Model.Is2faEnabled)
        {
            <div class="bg-gray-50 p-6 rounded-2xl mb-6">
                @if (Model.RecoveryCodesLeft == 0)
                {
                    <div class="flex items-center gap-3 p-4 bg-red-100 text-red-700 rounded-lg mb-4">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                        <div>
                            <strong>No recovery codes left.</strong>
                            <p>You must <a asp-page="./GenerateRecoveryCodes" class="text-blue-600 font-semibold">generate a new set</a> before using a recovery code.</p>
                        </div>
                    </div>
                }
                else if (Model.RecoveryCodesLeft == 1)
                {
                    <div class="flex items-center gap-3 p-4 bg-yellow-100 text-yellow-700 rounded-lg mb-4">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                        <div>
                            <strong>Only 1 recovery code left.</strong>
                            <p>You can <a asp-page="./GenerateRecoveryCodes" class="text-blue-600 font-semibold">generate a new set</a>.</p>
                        </div>
                    </div>
                }
                else if (Model.RecoveryCodesLeft <= 3)
                {
                    <div class="flex items-center gap-3 p-4 bg-yellow-100 text-yellow-700 rounded-lg mb-4">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                        <div>
                            <strong>@Model.RecoveryCodesLeft recovery codes left.</strong>
                            <p>Consider <a asp-page="./GenerateRecoveryCodes" class="text-blue-600 font-semibold">generating new recovery codes</a>.</p>
                        </div>
                    </div>
                }

                <div class="flex flex-wrap gap-3">
                    @if (Model.IsMachineRemembered)
                    {
                        <form method="post">
                            <button type="submit" class="flex items-center gap-2 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                                Forget this browser
                            </button>
                        </form>
                    }
                    <a asp-page="./Disable2fa" class="flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                        Disable 2FA
                    </a>
                    <a asp-page="./GenerateRecoveryCodes" class="flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
                        </svg>
                        Reset recovery codes
                    </a>
                </div>
            </div>
        }
        @if (!Model.Is2faEnabled)
        {

            <h4 class="text-xl font-semibold text-gray-800 mt-8">
                Authenticator App
            </h4>

            <div class="flex flex-wrap gap-3 mt-3">
                @if (!Model.HasAuthenticator)
                {
                    <a asp-page="./EnableAuthenticator" class="flex items-center gap-2 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        Add Authenticator App
                    </a>
                }
                else
                {
                    <a asp-page="./EnableAuthenticator" class="flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        Set up Authenticator App
                    </a>
                    <a asp-page="./ResetAuthenticator"
                       class="flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                        Reset Authenticator App
                    </a>
                }
            </div>
        }
    }
    else
    {
        <div class="flex items-center gap-3 p-4 bg-red-100 text-red-700 rounded-lg mt-4">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            <div>
                <strong>Privacy & cookie policy not accepted.</strong>
                <p>You must accept the policy before enabling 2FA.</p>
            </div>
        </div>
    }
}

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}
